#!/usr/bin/env node

/**
 * generate-ai-rules.js
 *
 * Reads universal rule files from .ai/rules/*.mdc and generates:
 *   - .cursor/rules/tegel-lite/*.mdc  (adds frontmatter with alwaysApply: true)
 *   - CLAUDE.md                       (all rules aggregated)
 *   - AGENTS.md                       (all rules aggregated)
 *   - .github/copilot-instructions.md (all rules aggregated)
 *
 * Pure Node.js — no external dependencies.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const packageRoot = path.resolve(__dirname, '..');

// Source directory for universal markdown rules
const rulesSourceDir = path.join(packageRoot, '.ai', 'rules');

// Output paths
const cursorOutputDir = path.join(packageRoot, '.cursor', 'rules', 'tegel-lite');
const claudeOutputPath = path.join(packageRoot, 'CLAUDE.md');
const agentsOutputPath = path.join(packageRoot, 'AGENTS.md');
const copilotOutputDir = path.join(packageRoot, '.github');
const copilotOutputPath = path.join(copilotOutputDir, 'copilot-instructions.md');

/**
 * Strip YAML frontmatter (--- ... ---) from file content if present.
 */
function stripFrontmatter(content) {
  const match = content.match(/^---\n[\s\S]*?\n---\n?/);
  return match ? content.slice(match[0].length) : content;
}

/**
 * Read all .mdc files from the source directory, sorted alphabetically.
 * Frontmatter is stripped so downstream generators can add their own.
 */
function readRuleFiles() {
  if (!fs.existsSync(rulesSourceDir)) {
    console.warn(`Warning: Rules source directory not found: ${rulesSourceDir}`);
    console.warn('Create .ai/rules/*.mdc files and re-run this script.');
    return [];
  }

  const files = fs
    .readdirSync(rulesSourceDir)
    .filter((f) => f.endsWith('.mdc'))
    .sort();

  if (files.length === 0) {
    console.warn('Warning: No .mdc files found in .ai/rules/');
    return [];
  }

  return files.map((filename) => {
    const raw = fs.readFileSync(path.join(rulesSourceDir, filename), 'utf-8');
    return {
      filename,
      name: path.basename(filename, '.mdc'),
      content: stripFrontmatter(raw).trim(),
    };
  });
}

/**
 * Generate .cursor/rules/tegel-lite/*.mdc files with frontmatter.
 */
function generateCursorRules(rules) {
  fs.mkdirSync(cursorOutputDir, { recursive: true });

  for (const rule of rules) {
    const frontmatter = ['---', `description: ${rule.name}`, 'alwaysApply: true', '---', ''].join(
      '\n',
    );

    const mdcContent = frontmatter + rule.content;
    const outputPath = path.join(cursorOutputDir, `${rule.name}.mdc`);

    fs.writeFileSync(outputPath, mdcContent, 'utf-8');
    console.log(`  Generated: .cursor/rules/tegel-lite/${rule.name}.mdc`);
  }
}

/**
 * Build aggregated markdown content from all rules.
 */
function buildAggregatedContent(rules) {
  const header = [
    '# @scania/tegel-lite — AI Coding Rules',
    '',
    '> Auto-generated by `npm run generate:ai-rules`. Do not edit manually.',
    '',
    `> Generated: ${new Date().toISOString().split('T')[0]}`,
    '',
    '',
  ].join('\n');

  const sections = rules.map((rule) => {
    return [`## ${rule.name}`, '', rule.content].join('\n');
  });

  return header + sections.join('\n\n---\n\n') + '\n';
}

/**
 * Generate a single aggregated file (CLAUDE.md, AGENTS.md, or copilot-instructions.md).
 */
function generateAggregatedFile(outputPath, content, label) {
  const dir = path.dirname(outputPath);
  fs.mkdirSync(dir, { recursive: true });
  fs.writeFileSync(outputPath, content, 'utf-8');

  const relativePath = path.relative(packageRoot, outputPath);
  console.log(`  Generated: ${relativePath} (${label})`);
}

// ── Main ──────────────────────────────────────────────────────────────────────

console.log('Generating AI rule files from .ai/rules/...\n');

const rules = readRuleFiles();

if (rules.length === 0) {
  console.log('\nNo rules to generate. Add .mdc files to .ai/rules/ and re-run.');
  process.exit(0);
}

console.log(`Found ${rules.length} rule file(s):\n`);

// Generate Cursor .mdc files
console.log('Cursor rules (.mdc):');
generateCursorRules(rules);

// Build aggregated content
const aggregated = buildAggregatedContent(rules);

// Generate CLAUDE.md
console.log('\nAggregated files:');
generateAggregatedFile(claudeOutputPath, aggregated, 'Claude Code');

// Generate AGENTS.md
generateAggregatedFile(agentsOutputPath, aggregated, 'OpenAI Codex');

// Generate .github/copilot-instructions.md
generateAggregatedFile(copilotOutputPath, aggregated, 'GitHub Copilot');

console.log(`\nDone! Generated files for ${rules.length} rule(s).`);
